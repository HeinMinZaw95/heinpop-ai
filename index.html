<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" name="icon-x/image" href="logo.svg">
    <title>HeinPop-AI</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar for a clean dark theme look */
        #chat-window::-webkit-scrollbar {
            width: 8px;
        }

        #chat-window::-webkit-scrollbar-track {
            background: #1f2937; /* Gray-800 */
        }

        #chat-window::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* Gray-600 */
            border-radius: 20px;
            border: 2px solid #111827; /* Gray-900 */
        }

        /* Set Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Simple animation for new message */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Main Chat Container -->
    <div class="w-full max-w-4xl h-[90vh] flex flex-col bg-gray-800 rounded-xl shadow-2xl">

        <!-- Header -->
        <header class="p-4 bg-gray-700 rounded-t-xl shadow-md flex items-center justify-between">
            <h1 class="text-2xl font-bold text-indigo-400 flex items-center">
                <img src="logo.svg" alt="logo" width="50px" style="margin-right: 1rem; ">
                <span style="color: #c31ec9;">HeinPop AI Chat</span>
            </h1>
            <img src="" alt="">
            <button id="new-chat-btn" style="background-color: white; display: flex; padding: 5px 15px; align-items: center; border-radius: 1rem; border: 1px solid #c31ec9; color: #c31ec9; font-weight: bold;" onclick="startNewChat()" >
                <i data-lucide="plus-circle" class="w-4 h-4 mr-1"></i>
                Clear Chat
            </button>
        </header>

        <!-- Chat Window -->
        <div id="chat-window" class="flex-1 overflow-y-auto p-4 space-y-4" style="background-color: black;">
            <!-- Initial welcome message -->
            <div class="flex justify-start" >
                <div class="bg-gray-700 p-3 rounded-xl rounded-tl-none max-w-[85%] sm:max-w-[70%] shadow-lg fade-in">
                    <p class="font-semibold text-indigo-300">HeinPop</p>
                    <p class="mt-1">·Äô·ÄÑ·Ä∫·Äπ·ÄÇ·Äú·Ä¨·Äï·Ä´ üòÄ ·Äò·Ä¨·Äô·Äª·Ä¨·Ä∏·Äû·Ä≠·ÄÅ·Äª·ÄÑ·Ä∫·Äê·Ä¨·Äõ·Äæ·Ä≠·Äú·Ä≠·ÄØ·Ä∑·Äú·Ä≤·Äó·Äª·Åã </p>
                </div>
            </div>
        </div>

        <!-- Message Input Area -->
        <footer class="p-4 bg-gray-700 rounded-b-xl border-t border-gray-600">
            <div class="flex space-x-3">
                <input
                    type="text"
                    id="user-input"
                    class="flex-1 p-3 bg-gray-900 border border-gray-600 text-gray-100 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
                    placeholder="Type your message here..."
                    onkeypress="if(event.key === 'Enter') sendMessage()"
                    autocomplete="off"
                >
                <button
                    id="send-button"
                    class="bg-white text-[#c31ec9ff] p-3 rounded-xl hover:bg-[#141414] transition duration-200 disabled:bg-indigo-800 disabled:opacity-50 shadow-lg flex items-center justify-center"
                    onclick="sendMessage()"
                >
                    <i data-lucide="send" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="error-message" class="mt-2 text-red-400 text-sm hidden"></div>
        </footer>

    </div>

    <script>
        // Global Constants
        const MODEL_NAME = "gemini-2.5-flash-preview-05-20";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent`;
        const apiKey = "AIzaSyBtoewxjHV2hGp_wuC3A8gHh7I5EKxn3mY"; // API key is provided by the environment
        
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const errorMessageDiv = document.getElementById('error-message');
        const MAX_RETRIES = 5;

        // Initialize Lucide icons
        window.onload = () => {
            lucide.createIcons();
            // Scroll to bottom on load
            chatWindow.scrollTop = chatWindow.scrollHeight;
        };

        /**
         * Simple utility to safely generate a random UUID.
         * Falls back to a simple timestamp + random number if crypto.randomUUID is unavailable.
         */
        const generateId = () => window.crypto.randomUUID ? window.crypto.randomUUID() : (Date.now().toString(36) + Math.random().toString(36).substring(2));

        /**
         * Adds a message to the chat window.
         * @param {string} role - 'user' or 'ai'
         * @param {string} text - The content of the message
         * @returns {HTMLElement} The created message element.
         */
        function addMessage(role, text) {
            const justifyClass = role === 'user' ? 'justify-end' : 'justify-start';
            const bgColor = role === 'user' ? 'bg-indigo-600' : 'bg-gray-700';
            const nameColor = role === 'user' ? 'text-indigo-200' : 'text-indigo-300';
            const name = role === 'user' ? 'You' : 'HeinPop AI';

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${justifyClass}`;
            messageDiv.innerHTML = `
                <div class="${bgColor} p-3 rounded-xl ${role === 'user' ? 'rounded-br-none' : 'rounded-tl-none'} max-w-[85%] sm:max-w-[70%] shadow-xl fade-in">
                    <p class="font-semibold ${nameColor}">${name}</p>
                    <div class="mt-1 message-content">${text}</div>
                </div>
            `;
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return messageDiv.querySelector('.message-content');
        }

        /**
         * Adds a temporary loading spinner while waiting for the AI response.
         * @returns {HTMLElement} The loading element wrapper.
         */
        function addLoadingIndicator() {
            const loadingWrapper = document.createElement('div');
            loadingWrapper.id = 'loading-indicator';
            loadingWrapper.className = 'flex justify-start';
            loadingWrapper.innerHTML = `
                <div class="bg-gray-700 p-3 rounded-xl rounded-tl-none shadow-lg w-20 flex justify-center items-center">
                    <svg class="animate-spin h-5 w-5 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            `;
            chatWindow.appendChild(loadingWrapper);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return loadingWrapper;
        }

        /**
         * Fetches data with exponential backoff retry logic.
         * @param {string} url - The API URL.
         * @param {object} options - Fetch options (method, headers, body).
         * @returns {Promise<Response>} The fetch response object.
         */
        async function exponentialBackoffFetch(url, options) {
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < MAX_RETRIES - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === MAX_RETRIES - 1) throw error;
                    // Wait for retry
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * Clears the chat window and displays the welcome message.
         */
        function startNewChat() {
            if (confirm("Are you sure you want to start a new chat? Your current conversation history will be cleared.")) {
                chatWindow.innerHTML = `
                    <div class="flex justify-start">
                        <div class="bg-gray-700 p-3 rounded-xl rounded-tl-none max-w-[85%] sm:max-w-[70%] shadow-lg fade-in">
                            <p class="font-semibold text-indigo-300">HeinPop AI</p>
                            <p class="mt-1">·Äô·ÄÑ·Ä∫·Äπ·ÄÇ·Äú·Ä¨·Äï·Ä´ üòÄ ·Äò·Ä¨·Äô·Äª·Ä¨·Ä∏·Äû·Ä≠·ÄÅ·Äª·ÄÑ·Ä∫·Äê·Ä¨·Äõ·Äæ·Ä≠·Äú·Ä≠·ÄØ·Ä∑·Äú·Ä≤·Äó·Äª·Åã </p>
                        </div>
                    </div>
                `;
                userInput.value = '';
                errorMessageDiv.classList.add('hidden');
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        }

        /**
         * Gathers the current chat history from the DOM to send to the API.
         * Note: This is a simplistic approach for a single-file demo.
         */
        function getChatHistory() {
            const history = [];
            const messages = chatWindow.querySelectorAll('.flex');

            messages.forEach(msgDiv => {
                const isUser = msgDiv.querySelector('.text-indigo-200');
                const role = isUser ? 'user' : 'model';
                const contentDiv = msgDiv.querySelector('.message-content');

                if (contentDiv) {
                    // Use innerText to strip HTML (like the loading spinner before it's removed)
                    let text = contentDiv.innerText.trim();

                    // Skip the initial welcome message from the history context, it's irrelevant.
                    if (messages.length > 1 && role === 'model' && text.startsWith("Hello! I'm HeinPop AI")) {
                        return; 
                    }
                    
                    history.push({
                        role: role,
                        parts: [{ text: text }]
                    });
                }
            });

            // The last item in history is the current user message, which is already formatted correctly.
            return history;
        }

        /**
         * Sends the user's message to the Gemini API and handles the response.
         */
        async function sendMessage() {
            const prompt = userInput.value.trim();
            if (!prompt) return;

            // 1. Display user message
            addMessage('user', prompt);
            userInput.value = ''; // Clear input
            sendButton.disabled = true;
            errorMessageDiv.classList.add('hidden');

            // 2. Add loading indicator
            const loadingIndicator = addLoadingIndicator();

            try {
                // 3. Construct payload
                const chatHistory = getChatHistory();
                const systemPrompt = "You are HeinPop AI, a helpful, ethical, and creative assistant. Format your responses using markdown for clarity (e.g., use bold, lists, and code blocks). Your goal is to provide accurate and detailed information.";

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }], // Only send the latest prompt for non-streaming
                    // In a real multi-turn chat, we would send the full history: contents: chatHistory
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                // 4. API Call
                const response = await exponentialBackoffFetch(`${API_URL}?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();

                // 5. Process response
                const candidate = result.candidates?.[0];
                let aiResponseText = "Sorry, I encountered an issue generating a response.";
                
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    aiResponseText = candidate.content.parts[0].text;
                } else if (result.error) {
                    aiResponseText = `Error: ${result.error.message}`;
                    console.error("API Error:", result.error);
                } else {
                    console.error("Unexpected API response structure:", result);
                }
                
                // 6. Remove loading indicator and display AI response
                loadingIndicator.remove();
                const aiContentDiv = addMessage('ai', `<p>${aiResponseText.replace(/\n/g, '<br>')}</p>`);

                // Simple markdown-like formatting (to handle code blocks/lists, we'd need a real markdown library)
                // For this demo, we'll just use a <pre> tag for simple code blocks if detected.
                if (aiResponseText.includes('```')) {
                    aiContentDiv.innerHTML = formatCodeBlocks(aiResponseText);
                }


            } catch (error) {
                console.error("Fetch or processing failed:", error);
                loadingIndicator.remove();
                errorMessageDiv.textContent = `Failed to connect to AI: ${error.message}`;
                errorMessageDiv.classList.remove('hidden');
                addMessage('ai', 'An error occurred while fetching the response. Please try again.');
            } finally {
                sendButton.disabled = false;
                userInput.focus();
            }
        }

        /**
         * Simple function to replace triple backticks with HTML pre/code tags
         * as a basic form of markdown rendering for code blocks.
         */
        function formatCodeBlocks(text) {
            let formattedText = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const parts = formattedText.split('```');
            let result = '';

            for (let i = 0; i < parts.length; i++) {
                if (i % 2 === 1) { // Inside a code block
                    let [lang, ...codeLines] = parts[i].split('\n');
                    let code = codeLines.join('\n');
                    
                    if (!code) {
                        code = lang;
                        lang = '';
                    }

                    // Simple syntax highlight hint using language name
                    result += `<pre class="mt-2 p-2 bg-gray-900 rounded-lg text-sm overflow-x-auto"><code class="language-${lang.trim() || 'plaintext'}">${code.trim()}</code></pre>`;
                } else { // Outside a code block
                    result += parts[i].replace(/\n/g, '<br>');
                }
            }
            return result;
        }

    </script>
    <noscript>
        <div class="absolute inset-0 bg-red-900 bg-opacity-90 flex items-center justify-center text-white text-xl">
            Please enable JavaScript to use the HeinPop AI Chat application.
        </div>
    </noscript>
</body>
</html>
